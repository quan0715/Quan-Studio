generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum PostStatus {
  draft
  published
}

enum NotionSyncJobStatus {
  pending
  processing
  succeeded
  failed
}

enum NotionSyncTrigger {
  button
  manual
  retry
}

enum NotionModelProjectionKind {
  flat_list
  resume_grouped
}

enum NotionModelFieldType {
  title
  rich_text
  select
  multi_select
  status
  number
  date
  checkbox
  url
  file
  media
  builtin
}

model Post {
  id                 String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  title              String
  slug               String     @unique
  excerpt            String?
  tags               String[]   @default([])
  status             PostStatus @default(draft)
  contentJson        Json       @map("content_json")
  coverUrl           String?    @map("cover_url")
  publishedAt        DateTime?  @map("published_at")
  notionPageId       String     @unique @map("notion_page_id")
  notionLastEditedAt DateTime?  @map("notion_last_edited_at")
  syncedAt           DateTime?  @map("synced_at")
  syncError          String?    @map("sync_error")
  createdAt          DateTime   @default(now()) @map("created_at")
  updatedAt          DateTime   @updatedAt @map("updated_at")

  @@index([status])
  @@index([publishedAt])
  @@index([syncedAt])
  @@map("posts")
}

model NotionSyncJob {
  id           String              @id @default(cuid())
  pageId       String              @map("page_id")
  triggerType  NotionSyncTrigger   @map("trigger_type")
  status       NotionSyncJobStatus @default(pending)
  attempt      Int                 @default(0)
  maxAttempts  Int                 @default(5) @map("max_attempts")
  nextRunAt    DateTime?           @map("next_run_at")
  lockedAt     DateTime?           @map("locked_at")
  lockedBy     String?             @map("locked_by")
  payloadJson  Json?               @map("payload_json")
  dedupeKey    String              @unique @map("dedupe_key")
  errorMessage String?             @map("error_message")
  createdAt    DateTime            @default(now()) @map("created_at")
  updatedAt    DateTime            @updatedAt @map("updated_at")

  @@index([status, nextRunAt])
  @@index([updatedAt])
  @@map("notion_sync_jobs")
}

model IntegrationConfig {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String   @db.Text
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([key])
  @@map("integration_configs")
}

model NotionModelDefinition {
  id                 String                   @id @default(cuid())
  modelKey           String                   @unique @map("model_key")
  label              String
  defaultDisplayName String                   @map("default_display_name")
  schemaSource       String                   @unique @map("schema_source")
  projectionKind     NotionModelProjectionKind @default(flat_list) @map("projection_kind")
  projectionConfigJson Json                   @default("{}") @map("projection_config_json")
  isActive           Boolean                  @default(true) @map("is_active")
  createdAt          DateTime                 @default(now()) @map("created_at")
  updatedAt          DateTime                 @updatedAt @map("updated_at")

  fields             NotionModelField[]
  binding            NotionModelBinding?

  @@index([isActive])
  @@map("notion_model_definitions")
}

model NotionModelField {
  id                String              @id @default(cuid())
  modelDefinitionId String              @map("model_definition_id")
  fieldKey          String              @map("field_key")
  appField          String              @unique @map("app_field")
  expectedType      NotionModelFieldType @map("expected_type")
  required          Boolean             @default(false)
  description       String
  defaultNotionField String?            @map("default_notion_field")
  builtinField      String?             @map("builtin_field")
  sortOrder         Int                 @default(0) @map("sort_order")
  createdAt         DateTime            @default(now()) @map("created_at")
  updatedAt         DateTime            @updatedAt @map("updated_at")

  modelDefinition   NotionModelDefinition @relation(fields: [modelDefinitionId], references: [id], onDelete: Cascade)

  @@unique([modelDefinitionId, fieldKey])
  @@index([modelDefinitionId, sortOrder])
  @@map("notion_model_fields")
}

model NotionModelBinding {
  id                String               @id @default(cuid())
  modelDefinitionId String               @unique @map("model_definition_id")
  dataSourceId      String               @map("data_source_id")
  createdAt         DateTime             @default(now()) @map("created_at")
  updatedAt         DateTime             @updatedAt @map("updated_at")

  modelDefinition   NotionModelDefinition @relation(fields: [modelDefinitionId], references: [id], onDelete: Cascade)

  @@index([dataSourceId])
  @@map("notion_model_bindings")
}

